//BBOalert, Bidding Scenarios - Dynamic Layout
//BBOalert, Bidding Scenarios - Dynamic Layout - version 1.7
Import,https://github.com/ADavidBailey/Practice-Bidding-Scenarios/blob/main/js/setDealerCode.js
Javascript,https://github.com/stanmaz/BBOalert/blob/master/Plugins/PBNcapture.js
Javascript,https://github.com/Rick-Wilson/bbo-pbs/blob/master/Plugins/BBAcompare.js
Import,https://github.com/stanmaz/BBOalert/blob/master/Scripts/PBStooltips.js

// Start BBA Auction Compare panel (called by Auction Compare button)
Script,startBBACompare,window.startBBACompare(); R='';

// Pause
Script,onLogin,setTimeout(setOptionsOff, 200);

// Open BBOalert Shortcuts
Script,onDataLoad,$('#bttab-buttons').click();

// Open usual BBO side panel
Script,onLogin,parent.$('.verticalClass')[0].click();

// Hide the Char, Word, All backspace buttons
Script,onDataLoad,$("#adpanel2 button:lt(3)").hide();

// Fix button row heights - make adjacent buttons equal height
Script,onDataLoad
var style = document.createElement('style');
style.textContent = `
  #adpanel2 {
    display: flex !important;
    flex-wrap: wrap !important;
    align-items: stretch !important;
    align-content: flex-start !important;
  }
  #adpanel2 button {
    align-items: center;
    justify-content: center;
    text-align: center;
  }
`;
document.head.appendChild(style);
Script

// Redirect chat so it doesn't go to Lobby
Script,onDataLoad
sendPrivateChat(whoAmI(),"");
setTimeout(function() {
   setChatDestination(whoAmI());
   },1000);
Script

//Script,setBiddingTable
var delayValue = 500;
Promise.resolve()
    .then(() => {
         const homeButton = $("nav-bar button", BBOcontext()).eq(0);
         const isDisabled = homeButton.prop('disabled');
         if (isDisabled) {
            console.log("The home button is disabled.");
         } else {
            console.log("The home button is enabled.");
            homeFound = true;
            alert("You must be at the BBO Home page to start a table.")
            throw new Error("Go Home.");
         }
    })
    .then(() => $(".menuGrid navigation-list-button .navClass", BBOcontext()).eq(4).click())
    .then(() => delay(delayValue))
    .then(() => $(".menuGrid navigation-list-button .navClass", BBOcontext()).eq(tableType).click())
    .then(() => $(".menuGrid navigation-list-button .navClass:visible", BBOcontext()).eq(0).click())
    .then(() => delay(delayValue))
    .then(() => $("table-options-panel .toggleDivClass ion-toggle", BBOcontext()).eq(0).click())
    .then(() => delay(delayValue))
    .then(() => $("table-options-panel .toggleDivClass ion-toggle", BBOcontext()).eq(1).click())
    .then(() => delay(delayValue))
    .then(() => $("table-options-panel .toggleDivClass ion-toggle", BBOcontext()).eq(2).click())
    .then(() => delay(delayValue))
    .then(() => $("table-options-panel .toggleDivClass ion-toggle", BBOcontext()).eq(3).click())
    .then(() => delay(delayValue))
    .then(() => $("table-options-panel .toggleDivClass ion-toggle", BBOcontext()).eq(4).click())
    .then(() => delay(delayValue))
    .then(() => $("start-table-screen .buttonRowClass button", BBOcontext()).eq(2).click())
    .then(() => delay(3000))
    .then(() => $("bridge-screen .nameDisplayClass", BBOcontext()).eq(0).click())
    .then(() => delay(delayValue))
    .then(() => $("bridge-screen menu-item", BBOcontext()).eq(0).children().click())
    .then(() => delay(delayValue))
    .then(() => $("bridge-screen .nameDisplayClass", BBOcontext()).eq(1).click())
    .then(() => delay(delayValue))
    .then(() => $("bridge-screen menu-item", BBOcontext()).eq(0).children().click())
    .then(() => delay(delayValue))
    .then(() => $("bridge-screen .nameDisplayClass", BBOcontext()).eq(2).click())
    .then(() => delay(delayValue))
    .then(() => $("bridge-screen menu-item", BBOcontext()).eq(0).children().click())
    .then(() => delay(delayValue))
    .then(() => $("bridge-screen .nameDisplayClass", BBOcontext()).eq(3).click())
    .then(() => delay(delayValue))
    .then(() => $("bridge-screen menu-item", BBOcontext()).eq(0).children().click())
function delay(duration) {
    return new Promise((resolve) => {
        setTimeout(resolve, duration);
    });
}
//Script

//Script,setTeachingTable
var delayValue = 500;
Promise.resolve()
    .then(() => {
         const homeButton = $("nav-bar button", BBOcontext()).eq(0);
         const isDisabled = homeButton.prop('disabled');
         if (isDisabled) {
            console.log("The home button is disabled.");
         } else {
            console.log("The home button is enabled.");
            homeFound = true;
            alert("You must be at the BBO Home page to start a table.")
            throw new Error("Go Home.");
         }
    })
    .then(() => $(".menuGrid navigation-list-button .navClass", BBOcontext()).eq(4).click())
    .then(() => delay(delayValue))
    .then(() => $(".menuGrid navigation-list-button .navClass:visible", BBOcontext()).eq(1).click())
    .then(() => delay(delayValue))
    .then(() => $("table-options-panel .toggleDivClass ion-toggle", BBOcontext()).eq(0).click())
    .then(() => delay(delayValue))
    .then(() => $("table-options-panel .toggleDivClass ion-toggle", BBOcontext()).eq(1).click())
    .then(() => delay(delayValue))
    .then(() => $("table-options-panel .toggleDivClass ion-toggle", BBOcontext()).eq(2).click())
    .then(() => delay(delayValue))
    .then(() => $("table-options-panel .toggleDivClass ion-toggle", BBOcontext()).eq(3).click())
    .then(() => delay(delayValue))
    .then(() => $("table-options-panel .toggleDivClass ion-toggle", BBOcontext()).eq(4).click())
    .then(() => delay(delayValue))
    .then(() => $("start-table-screen .buttonRowClass button", BBOcontext()).eq(2).click())
    .then(() => delay(3000))
    .then(() => $("bridge-screen .nameDisplayClass", BBOcontext()).eq(0).click())
    .then(() => delay(delayValue))
    .then(() => $("bridge-screen menu-item", BBOcontext()).eq(0).children().click())
    .then(() => delay(delayValue))
    .then(() => $("bridge-screen .nameDisplayClass", BBOcontext()).eq(1).click())
    .then(() => delay(delayValue))
    .then(() => $("bridge-screen menu-item", BBOcontext()).eq(0).children().click())
    .then(() => delay(delayValue))
    .then(() => $("bridge-screen .nameDisplayClass", BBOcontext()).eq(2).click())
    .then(() => delay(delayValue))
    .then(() => $("bridge-screen menu-item", BBOcontext()).eq(0).children().click())
    .then(() => delay(delayValue))
    .then(() => $("bridge-screen .nameDisplayClass", BBOcontext()).eq(3).click())
    .then(() => delay(delayValue))
    .then(() => $("bridge-screen menu-item", BBOcontext()).eq(0).children().click())
function delay(duration) {
    return new Promise((resolve) => {
        setTimeout(resolve, duration);
    });
}
//Script

// Log PBS scenario selection for analytics
Script,logPBS
if (window._pbsScenario) {
    window.currentPBSScenario = window._pbsScenario;
    fetch('https://bba-server.bridgebidding.ai/api/scenario/select', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Client-Version': '1.0.0'
        },
        body: JSON.stringify({
            scenario: window._pbsScenario,
            user: whoAmI() || 'anonymous'
        })
    }).catch(function(){});
    window._pbsScenario = undefined;
}
R='';
Script

Script,reviewCurrentCode,setDealerCode("");

Option,Practice Table

// Dynamic Layout System v1.2
// Fetches layout configuration and PBS metadata at runtime
// Always fetches fresh data - no caching
Script,onDataLoad
(function() {
    // Configuration for PBS Dynamic Layout
    var pbsConfig = {
        Enable_Test_Mode: false
    };

    // Register plugin config for test mode toggle
    var savedConfig = addConfigBox('PBS Dynamic Layout', pbsConfig);
    if (savedConfig) pbsConfig = savedConfig;

    // GitHub URLs
    var GITHUB_OWNER = 'ADavidBailey';
    var GITHUB_REPO = 'Practice-Bidding-Scenarios';
    var LAYOUT_URL = 'https://raw.githubusercontent.com/' + GITHUB_OWNER + '/' + GITHUB_REPO + '/main/btn/-layout.txt';
    var PBS_TEST_API = 'https://api.github.com/repos/' + GITHUB_OWNER + '/' + GITHUB_REPO + '/contents/pbs-test';
    var PBS_TEST_BASE = 'https://raw.githubusercontent.com/' + GITHUB_OWNER + '/' + GITHUB_REPO + '/main/pbs-test';
    var PBS_BETA_BASE = 'https://raw.githubusercontent.com/' + GITHUB_OWNER + '/' + GITHUB_REPO + '/main/pbs-beta';

    // Fetch and parse PBS file metadata (button text and style)
    // Both pbs-beta and pbs-test use .pbs extension
    function fetchPbsMetadata(name, baseUrl) {
        var rawUrl = baseUrl + '/' + name + '.pbs';
        return fetch(rawUrl)
            .then(function(response) { return response.text(); })
            .then(function(content) {
                return parsePbsButton(content, name);
            })
            .catch(function(err) {
                console.warn('PBS Dynamic: Failed to fetch metadata for', name);
                return { text: name.replace(/_/g, ' '), style: {} };
            });
    }

    // Parse Button line from PBS content
    function parsePbsButton(content, name) {
        var result = { text: name.replace(/_/g, ' '), style: {} };

        // Find the Button line - format: Button,<text>,<multiline chat>%alias%,<style>
        var buttonMatch = content.match(/^Button,([^,\n]+)/m);
        if (buttonMatch) {
            result.text = buttonMatch[1].trim();
        }

        // Find style after %alias% - look for the pattern %...%,<style>
        var styleMatch = content.match(/%[^%]+%,([^\n]+)$/m);
        if (styleMatch) {
            var styleStr = styleMatch[1].trim();
            var styleParts = styleStr.split(/\s+/);
            for (var i = 0; i < styleParts.length; i++) {
                var kv = styleParts[i].split('=');
                if (kv.length === 2) {
                    result.style[kv[0]] = kv[1];
                }
            }
        }

        return result;
    }

    // Parse button item from layout line
    function parseButtonItem(item) {
        item = item.trim();
        var parts = item.split(':');
        var name = parts[0];
        var color = null;
        var width = null;

        for (var i = 1; i < parts.length; i++) {
            if (parts[i].endsWith('%')) {
                width = parts[i];
            } else {
                color = parts[i];
            }
        }

        return { name: name, color: color, width: width };
    }

    // Parse layout line into button array
    function parseLayoutLine(line) {
        var buttons = [];
        var parts = [];
        var current = '';
        var parenDepth = 0;

        for (var i = 0; i < line.length; i++) {
            var char = line[i];
            if (char === '(') {
                parenDepth++;
                current += char;
            } else if (char === ')') {
                parenDepth--;
                current += char;
            } else if (char === ',' && parenDepth === 0) {
                parts.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        if (current.trim()) {
            parts.push(current.trim());
        }

        for (var j = 0; j < parts.length; j++) {
            var part = parts[j].trim();
            if (part.startsWith('(') && part.endsWith(')')) {
                var groupContent = part.slice(1, -1);
                var groupItems = groupContent.split(',').map(function(s) { return s.trim(); });
                var totalWidth = 50;
                var n = groupItems.length;
                var baseWidth = Math.floor(totalWidth / n);
                var remainder = totalWidth % n;

                for (var k = 0; k < groupItems.length; k++) {
                    var btn = parseButtonItem(groupItems[k]);
                    btn.width = btn.width || (baseWidth + (k >= n - remainder ? 1 : 0)) + '%';
                    btn.grouped = true;
                    buttons.push(btn);
                }
            } else {
                var btn = parseButtonItem(part);
                btn.grouped = false;
                buttons.push(btn);
            }
        }

        var nonGrouped = buttons.filter(function(b) { return !b.grouped; });
        var grouped = buttons.filter(function(b) { return b.grouped; });

        if (nonGrouped.length === 1 && grouped.length === 0) {
            if (!nonGrouped[0].width) nonGrouped[0].width = '100%';
        } else if (nonGrouped.length === 2 && grouped.length === 0) {
            nonGrouped.forEach(function(b) { if (!b.width) b.width = '50%'; });
        } else if (nonGrouped.length === 1 && grouped.length > 0) {
            if (!nonGrouped[0].width) nonGrouped[0].width = '50%';
        } else if (nonGrouped.length === 2) {
            nonGrouped.forEach(function(b) { if (!b.width) b.width = '50%'; });
        }

        return buttons;
    }

    // Create a button element
    function createButton(text, action, style, insertBefore) {
        var adPanel = document.getElementById('adpanel2');
        if (!adPanel) return null;

        var bt = document.createElement('button');
        bt.textContent = text;
        bt.value = action || '';
        bt.style.backgroundColor = style.backgroundColor || 'white';
        bt.style.color = style.color || 'black';
        bt.style.textAlign = 'center';
        bt.style.display = 'inline';
        bt.style.fontSize = '20px';
        bt.style.width = style.width || '50%';

        if (action && action.startsWith('%') && action.endsWith('%')) {
            bt.onclick = function() { execUserScript(action); };
        } else if (action && action.startsWith('http')) {
            bt.onclick = function() { window.open(action, '_blank'); };
        }

        if (insertBefore) {
            adPanel.insertBefore(bt, insertBefore);
        } else {
            adPanel.appendChild(bt);
        }
        return bt;
    }

    // Create a scenario button - button created sync, metadata loaded async
    function createScenarioButton(name, layoutStyle) {
        var adPanel = document.getElementById('adpanel2');
        if (!adPanel) return null;

        var bt = document.createElement('button');
        // Start with filename as text, will be updated when metadata loads
        bt.textContent = name.replace(/_/g, ' ');
        bt.style.backgroundColor = layoutStyle.backgroundColor || 'white';
        bt.style.color = layoutStyle.color || 'black';
        bt.style.textAlign = 'center';
        bt.style.display = 'inline';
        bt.style.fontSize = '20px';
        bt.style.width = layoutStyle.width || '50%';
        bt.setAttribute('data-scenario', name);
        bt.setAttribute('data-pbs-url', PBS_BETA_BASE + '/' + name + '.pbs');

        // Add button to panel immediately (sync)
        adPanel.appendChild(bt);

        // Fetch metadata async and update button
        fetchPbsMetadata(name, PBS_BETA_BASE).then(function(meta) {
            bt.textContent = meta.text;
            if (meta.style.backgroundColor) bt.style.backgroundColor = meta.style.backgroundColor;
            if (meta.style.color && !layoutStyle.color) bt.style.color = meta.style.color;
            if (meta.style.width && !layoutStyle.width) bt.style.width = meta.style.width;
        });

        bt.onclick = function() {
            var scenarioName = this.getAttribute('data-scenario');
            var url = this.getAttribute('data-pbs-url');
            console.log('PBS Dynamic: Loading scenario', scenarioName);

            fetch(url)
                .then(function(response) { return response.text(); })
                .then(function(content) {
                    var match = content.match(/setDealerCode\(`([\s\S]*?)`,\s*"([NSEW])",\s*(true|false)\)/);
                    if (match) {
                        window.currentPBSScenario = scenarioName;
                        window.currentPBSScenarioFilename = scenarioName;
                        fetch('https://bba.harmonicsystems.com/api/scenario/select', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-Client-Version': '1.0.0' },
                            body: JSON.stringify({ scenario: scenarioName, user: whoAmI() || 'anonymous' })
                        }).catch(function() {});
                        setDealerCode(match[1], match[2], match[3] === 'true');
                    }
                })
                .catch(function(err) { console.error('PBS Dynamic: Failed to load', scenarioName, err); });
        };

        return bt;
    }

    // Load test files from GitHub API
    function loadTestFiles() {
        return fetch(PBS_TEST_API)
            .then(function(response) { return response.json(); })
            .then(function(files) {
                var testFiles = files
                    .filter(function(f) { return f.name.endsWith('.pbs'); })
                    .map(function(f) { return f.name.replace('.pbs', ''); })
                    .sort();
                console.log('PBS Dynamic: Found', testFiles.length, 'test files');
                return testFiles;
            })
            .catch(function(err) {
                console.error('PBS Dynamic: Failed to load test files', err);
                return [];
            });
    }

    // Add test mode buttons - inserts after action buttons, before first section
    function addTestModeButtons() {
        if (!pbsConfig.Enable_Test_Mode) return Promise.resolve();

        return loadTestFiles().then(function(testFiles) {
            var adPanel = document.getElementById('adpanel2');
            if (!adPanel) return;

            // Find the first section header (lightblue that's not an action button)
            // Section headers have lightblue background and 100% width
            var allBtns = adPanel.querySelectorAll('button');
            var insertBefore = null;
            for (var i = 0; i < allBtns.length; i++) {
                var btn = allBtns[i];
                if (btn.style.backgroundColor === 'lightblue' && btn.style.width === '100%') {
                    insertBefore = btn;
                    break;
                }
            }

            // Create collapsible test section header (blue like other sections)
            var headerBtn = document.createElement('button');
            headerBtn.textContent = 'TEST: pbs-test/ (click to collapse)';
            headerBtn.style.width = '100%';
            headerBtn.style.backgroundColor = 'lightblue';
            headerBtn.style.color = 'black';
            headerBtn.style.fontWeight = 'bold';
            headerBtn.style.display = 'inline';
            headerBtn.style.fontSize = '18px';
            headerBtn.setAttribute('data-test-header', 'true');
            adPanel.insertBefore(headerBtn, insertBefore);

            // Create test buttons sync, load metadata async
            testFiles.forEach(function(name) {
                var bt = document.createElement('button');
                bt.textContent = name.replace(/_/g, ' ');
                bt.style.backgroundColor = 'white';
                bt.style.color = 'black';
                bt.style.textAlign = 'center';
                bt.style.display = 'inline';
                bt.style.fontSize = '18px';
                bt.style.width = '50%';
                bt.setAttribute('data-scenario', name);
                bt.setAttribute('data-test-button', 'true');
                adPanel.insertBefore(bt, insertBefore);

                // Load metadata async and update button
                fetchPbsMetadata(name, PBS_TEST_BASE).then(function(meta) {
                    bt.textContent = meta.text;
                    if (meta.style.backgroundColor) bt.style.backgroundColor = meta.style.backgroundColor;
                    if (meta.style.color) bt.style.color = meta.style.color;
                });

                bt.onclick = function() {
                    var scenarioName = this.getAttribute('data-scenario');
                    var url = PBS_TEST_BASE + '/' + scenarioName + '.pbs';
                    fetch(url)
                        .then(function(response) { return response.text(); })
                        .then(function(content) {
                            var match = content.match(/setDealerCode\(`([\s\S]*?)`,\s*"([NSEW])",\s*(true|false)\)/);
                            if (match) {
                                window.currentPBSScenario = scenarioName;
                                setDealerCode(match[1], match[2], match[3] === 'true');
                            }
                        })
                        .catch(function(err) { console.error('PBS (TEST):', err); });
                };
            });

            // Add click handler for collapse/expand
            headerBtn.onclick = function() {
                var testBtns = adPanel.querySelectorAll('[data-test-button]');
                for (var i = 0; i < testBtns.length; i++) {
                    $(testBtns[i]).toggle();
                }
            };
        });
    }

    // Parse and render layout - buttons created sync, metadata loaded async
    function renderLayout(layoutText) {
        var lines = layoutText.split('\n');

        for (var i = 0; i < lines.length; i++) {
            var line = lines[i].trim();

            if (!line || line.startsWith('#')) continue;

            if (line.startsWith('[Major]')) {
                var content = line.slice(7).trim();
                var title = content;
                var url = null;
                if (content.indexOf('|') !== -1) {
                    var parts = content.split('|');
                    title = parts[0].trim();
                    url = parts[1].trim();
                }
                createButton(title, url ? url + '\\n' : '', { width: '100%', backgroundColor: 'LemonChiffon' });
                continue;
            }

            if (line.startsWith('[Section]')) {
                var content = line.slice(9).trim();
                var title = content;
                var url = null;
                if (content.indexOf('|') !== -1) {
                    var parts = content.split('|');
                    title = parts[0].trim();
                    url = parts[1].trim();
                }
                var btn = createButton(title, url ? url + '\\n' : '', { width: '100%', backgroundColor: 'lightblue' });
                if (btn) {
                    btn.onclick = function() {
                        var next = $(this).next();
                        while (next.length && (next[0].style.backgroundColor === 'white' || next[0].style.backgroundColor === 'lightpink' || next[0].style.backgroundColor === 'lightyellow')) {
                            $(next).toggle();
                            next = $(next).next();
                        }
                    };
                }
                continue;
            }

            if (line.startsWith('[Action]')) {
                var content = line.slice(8).trim();
                var parts = content.split('|');
                var text = parts[0].trim();
                var script = parts[1] ? parts[1].trim() : '';
                var width = parts[2] ? parts[2].trim() + '%' : '50%';
                createButton(text, script, { width: width, backgroundColor: 'lightgreen' });
                continue;
            }

            if (line === '---') {
                createButton('---', '', { width: '100%', backgroundColor: 'white' });
                continue;
            }

            // Button row - create buttons sync, metadata loaded async
            var buttons = parseLayoutLine(line);
            for (var j = 0; j < buttons.length; j++) {
                var layoutBtn = buttons[j];
                if (layoutBtn.name === '---') {
                    createButton('---', '', { width: layoutBtn.width || '50%', backgroundColor: 'white' });
                } else {
                    var style = { width: layoutBtn.width || '50%' };
                    if (layoutBtn.color) style.color = layoutBtn.color;
                    createScenarioButton(layoutBtn.name, style);
                }
            }
        }
    }

    // Main initialization
    function init() {
        console.log('PBS Dynamic v1.7: Initializing...');
        console.log('PBS Dynamic: Test mode =', pbsConfig.Enable_Test_Mode);

        // First render the layout (major header, action buttons, sections)
        fetch(LAYOUT_URL)
            .then(function(response) { return response.text(); })
            .then(function(layoutText) {
                console.log('PBS Dynamic: Layout loaded,', layoutText.split('\n').length, 'lines');
                renderLayout(layoutText);
            })
            .then(function() {
                // Then insert test buttons after action buttons, before first section
                return addTestModeButtons();
            })
            .then(function() {
                console.log('PBS Dynamic: Initialization complete');
            })
            .catch(function(err) {
                console.error('PBS Dynamic: Initialization failed', err);
            });
    }

    setTimeout(init, 100);
})();
Script

Option

